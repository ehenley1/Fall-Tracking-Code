import os
import shutil
import subprocess 
import zipfile

#Directory of video files
video_dir = "C:\\Users\\Helmet_pro\\Falls_Study\\TEST_INPUT"

#Directory for JSON files
json_dir = "C:\\Users\\Helmet_pro\\Falls_Study\\TEST_OUTPUT"

#Path to OpenPoseDemo.exe
openpose_exe = "C:\\Users\\Helmet_pro\\openpose\\build\\x64\\Release\\OpenPoseDemo.exe"

#OpenPose flags
#net_resolution = "656x368"   #determines resolution of the pose estimation
net_resolution = "1712x960" #MAX RESOLUTION RECOMMENDED FOR BODY_25B
#net_resolution = "-1x368"
scale_number  = 4
scale_gap = 0.25
model_pose = "BODY_25B"

#Loop over video_dir
for filename in os.listdir(video_dir):
    #Check if file is a video
    if filename.endswith(".avi"):
        #Path to video file
        video_file = os.path.join(video_dir, filename)

        # Create a subdirectory for the video's output
        video_output_dir = os.path.join(json_dir, os.path.splitext(filename)[0])
        os.makedirs(video_output_dir, exist_ok=True)

        #Run OpenPose
        command = [openpose_exe, "--video", video_file, "--model_pose", model_pose, 
                   "--net_resolution", net_resolution, "--scale_number", str(scale_number), 
                   "--scale_gap", str(scale_gap), "--write_json", json_dir]
        subprocess.run(command)

        #Move JSON Files to new zip file
        for file in os.listdir(json_dir):
            if file.endswith(".json"):
                shutil.move(os.path.join(json_dir, file), video_output_dir)


         # Zip the output directory
        with zipfile.ZipFile(f"{video_output_dir}.zip", 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk(video_output_dir):
                for file in files:
                    zipf.write(os.path.join(root, file), 
                               os.path.relpath(os.path.join(root, file), video_output_dir))
        #Remove original file
        shutil.rmtree(video_output_dir)
        
